<header
  class="flex justify-between items-center p-4 bg-gradient-to-r from-[#0A1A20] to-[#0F1F26] 
         shadow-lg text-cyan-100  top-0 z-50">
  <h2 class="text-lg md:text-xl font-bold tracking-wide drop-shadow">
    {{ selectedPhrases() === '' 
        ? 'ğŸ“š Pick a list â†’' 
        : 'Currently studying: ' + selectedPhrases() }}
  </h2>

  <button
    (click)="toggleS()"
    class="bg-cyan-500 hover:bg-cyan-400 active:scale-95 
           text-white px-4 py-2 rounded-lg shadow-md 
           transition-all duration-300 ease-out"
  >
    {{ sideBar ? 'âœ– Close' : 'â˜° Menu' }}
  </button>
</header>

<!-- BACKDROP -->
<div *ngIf="sideBar"
     class="fixed inset-0 bg-grey/60  backdrop-blur-sm z-40 flex items-center mt-[6rem] justify-center animate-fade-in">
  
  <!-- MODAL PANEL -->
  <div class="bg-[#062d32] text-white w-[90%] max-w-lg rounded-2xl shadow-2xl 
              p-6 space-y-6 z-50 overflow-y-auto max-h-[80vh] border border-cyan-800 animate-slide-up">
    
    <!-- Close Button -->
    <div class="flex justify-end">
      <button
        class="text-sm bg-cyan-800 hover:bg-cyan-700 px-3 py-1 rounded-lg 
               transition-all duration-200 ease-in-out active:scale-95"
        (click)="toggleSidebar()"
      >
        âœ– Close
      </button>
    </div>

    <!-- Story Section -->
    <div class="overflow-y-auto max-h-80">
      <h2 class="text-xl font-bold mb-3 text-cyan-300">
        {{ selectedPhrases() === '' ? 'Pick a phrase' : 'Selected: ' + selectedPhrases() }}
      </h2>

      <h2 class="text-lg font-semibold mt-4 mb-2 border-b border-cyan-700 pb-1 text-cyan-200">
        Story
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button
          *ngFor="let item of storyList"
          (click)="getPhrase(item.s)"
          [ngClass]="item.isDone ? 'bg-emerald-700' : 'bg-cyan-600'"
          class="text-white px-4 py-2 rounded-xl hover:bg-cyan-500 
                 shadow-md transition-all duration-200 ease-in-out active:scale-95"
        >
          {{ item.s }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- START SECTION -->
<div *ngIf="isReadyToStart() && !startNow" class="text-center mt-8 px-4 animate-fade-in">
  <button (click)="startStudy()"
          class="bg-gradient-to-r from-green-600 to-emerald-500 
                 hover:from-green-500 hover:to-emerald-400 text-white 
                 px-8 py-3 rounded-xl shadow-lg font-semibold 
                 transition-all duration-300 ease-in-out active:scale-95">
    â–¶ Start
  </button>

  <!-- Role Selection -->
  <div class="mt-6">
    <label class="font-semibold text-cyan-200 mr-2">Choose Role:</label>
    <select [(ngModel)]="userRole"
            class="border border-cyan-400 bg-cyan-950 text-cyan-100 
                   px-3 py-2 rounded-lg focus:ring-2 focus:ring-cyan-500 outline-none">
      <option value="lead">ğŸ‘¤ I Lead</option>
      <option value="follow">ğŸ¤– Bot Leads</option>
    </select>
  </div>

  <!-- MODE TOGGLE -->
  <div class="flex justify-center flex-wrap gap-3 mt-6">
    <button *ngFor="let mode of ['type', 'speech', 'practice']"

            (click)="setMode(mode)"
            [class.bg-cyan-700]="inputMode === mode"
            class="bg-cyan-500 hover:bg-cyan-600 text-white px-5 py-2 
                   rounded-full shadow transition-all duration-200 ease-in-out active:scale-95">
      {{ mode === 'type' ? 'âœï¸ Type' : mode === 'speech' ? 'ğŸ¤ Speak' : 'â–¶ Practice' }}
    </button>
  </div>

  <!-- Pronunciation Toggle -->
  <div *ngIf="inputMode==='type'" class="text-center mt-4">
    <button (click)="showPro()"
            [ngClass]="showPronunciation?'bg-cyan-700':'bg-cyan-500'"
            class="hover:bg-cyan-600 text-white px-5 py-2 rounded-full shadow-md transition-all duration-200 ease-in-out active:scale-95">
      {{ showPronunciation ? 'Hide' : 'Show' }} Pronunciation
    </button>
  </div>

  <!-- Info Card -->
  <div class="bg-white/10 backdrop-blur-md text-slate-100 mt-8 
              shadow-lg rounded-2xl p-6 mx-auto max-w-md hover:shadow-xl 
              transition-transform transform hover:-translate-y-0.5">
    <h2 class="text-2xl font-bold text-center text-cyan-300 mb-2">Chat Mode</h2>
    <p class="text-center text-sm text-gray-200 leading-relaxed">
      Chat naturally in multiple languages with a smart partner that adjusts to your level.
    </p>
  </div>
</div>

<!-- //////////////////////////////////////////// -->
<!-- CHAT CONTAINER -->
<div *ngIf="startNow" class="px-4">
  <div class="flex flex-col h-[90vh] sm:h-[80vh] max-w-2xl mx-auto 
              bg-gradient-to-br from-slate-50 to-slate-200 
              rounded-3xl shadow-2xl overflow-hidden">

    <!-- CHAT HISTORY -->
    <div #chatContainer 
         class="flex-1 overflow-y-auto px-4 py-4 space-y-4 bg-gray-50">
      <div *ngFor="let msg of chatHistory" class="flex"
           [ngClass]="{ 'justify-end': msg.sender === 'user', 'justify-start': msg.sender === 'bot' }">
        <div
          (click)="playSpeech(msg)"
          class="max-w-[80%] px-4 py-2 rounded-2xl shadow-sm cursor-pointer 
                 transition-all duration-300 ease-in-out"
          [ngClass]="[
            msg.sender === 'user'
              ? 'bg-gradient-to-r from-cyan-600 to-cyan-500 text-white rounded-br-none animate-fade-user'
              : 'bg-gray-200 text-gray-900 rounded-bl-none animate-fade-bot'
          ]">
          <div class="font-medium text-sm">
            {{ msg.text }}
            <ng-container *ngIf="msg.correct !== undefined">
              <span class="ml-2" [ngClass]="msg.correct ? 'text-green-300' : 'text-red-300'">
                {{ msg.correct ? 'âœ…' : 'âŒ' }}
              </span>
            </ng-container>
          </div>
          <div *ngIf="msg.pr" class="text-xs mt-1 opacity-70">ğŸ”ˆ {{ msg.pr }}</div>
          <div *ngIf="msg.en" class="text-xs mt-1 text-gray-700">ğŸ’¬ {{ msg.en }}</div>
        </div>
      </div>
    </div>

    <!-- INPUT AREA -->
    <div class="bg-cyan-500 px-4 py-3 border-t border-cyan-400"> 
      <div class="flex flex-col sm:flex-row items-stretch gap-3">
        <!-- Type Mode -->
        <ng-container *ngIf="inputMode === 'type'">
          <div class="flex gap-2 items-center">
            <input [(ngModel)]="userInput"
                   #inputRef
                   (input)="updateCursor(inputRef)"
                   (click)="updateCursor(inputRef)"
                   class="flex-1 text-sm px-3 py-2 rounded-lg border bg-cyan-800 text-white
                          border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-300"
                   placeholder="Type your answer..." />
            <button (click)="submit()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg shadow transition-all duration-200 ease-in-out active:scale-95">
              Submit
            </button>
          </div>

          <!-- âœ… Hint Characters (Restored) -->
<div *ngIf="getSpeaker(storyTurn()) === 'user'" class="mt-4">
  <!-- Hint Label -->
  <p
    (click)="generateHint1()"
    title="Click to show hint characters if no keyboard"
    class="text-sm font-semibold text-gray-200 bg-cyan-800 rounded p-2 mb-2 cursor-pointer hover:bg-cyan-700 transition"
  >
    ğŸ’¡ Show Hint Characters
  </p>

  <!-- Character Buttons -->
  <div
    *ngIf="hint1"
    class="flex flex-wrap gap-2 overflow-y-auto max-h-[30vh] animate-fadeIn"
  >
    <button
      *ngFor="let char of hint1Array"
      (click)="appendToInput(char, inputRef)"
      class="bg-emerald-100 hover:bg-emerald-200 text-emerald-800 font-medium px-3 py-1 rounded-lg shadow-sm transition transform hover:scale-105"
    >
      {{ char }}
    </button>
  </div>
</div>

        </ng-container>

        <!-- Speech Mode -->
        <button *ngIf="inputMode === 'speech'" (click)="startSpeechToText()"
                class="w-full sm:w-auto bg-cyan-700 hover:bg-cyan-800 text-white 
                       px-4 py-2 rounded-full shadow-md transition-all duration-200 ease-in-out active:scale-95">
          ğŸ™ Speak
        </button>

        <!-- Practice Mode -->
        <button *ngIf="inputMode === 'practice' && !ToBegin" (click)="advanceStory()"
                class="w-full sm:w-auto bg-cyan-700 hover:bg-cyan-800 text-white 
                       px-4 py-2 rounded-lg shadow-md transition-all duration-200 ease-in-out active:scale-95">
          â–¶ Next
        </button>
      </div>

      <!-- Turn Info -->
      <div class="text-sm text-white mt-4 text-center">
                <!-- BEGIN BUTTON for USER -->
        <div *ngIf="ToBegin && getSpeaker(storyTurn()) === 'user'" class="text-center my-4 animate-fade-in">
          <button *ngIf="inputMode === 'practice'"
                  (click)="startUserTurn()"
                  class="bg-gradient-to-r from-emerald-600 to-green-500 
                        hover:from-emerald-500 hover:to-green-400 
                        text-white px-6 py-3 rounded-full shadow-lg font-semibold 
                        transition-all duration-300 ease-in-out active:scale-95">
            â–¶ Begin Turn
          </button>
        </div>

        <ng-container *ngIf="getSpeaker(storyTurn()) === 'user'; else botTurn">
          {{ userRole === 'lead' ? 'Say in' : 'Reply in' }} {{ id }}:
          <strong>{{ chatData[index]?.[storyTurn()]?.en }}</strong>
        </ng-container>
        <ng-template #botTurn>
          ğŸ¤– Robotâ€™s turn...
          <div *ngIf="botTyping" class="bot-typing">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>
